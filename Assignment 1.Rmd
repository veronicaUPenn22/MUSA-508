---
title: "MUSA 508 Assignment 1"
author: "Veronica Rosado & Weslene Uy"
date: "9/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## Load Libraries
install.packages("crimedata")
install.packages("kable")
install.packages("kableExtra")
library(crimedata) #Getting this: Error in library(crimedata) : there is no package called ‘crimedata’ 
library(tidyverse)
library(tidycensus)
library(sf)
library(kableExtra)


options(scipen=999) 
options(tigris_class = "sf")

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r graphic themes, warning = FALSE}

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

# Load Quantile break functions

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

q5 <- function(variable) {as.factor(ntile(variable, 5))}

# Multiple Ring Buffer Function

multipleRingBuffer <- function(inputPolygon, maxDistance, interval) 
{
  distances <- seq(0, maxDistance, interval)
  distancesCounter <- 2
  numberOfRings <- floor(maxDistance / interval)
  numberOfRingsCounter <- 1
  allRings <- data.frame()
  
  while (numberOfRingsCounter <= numberOfRings) 
  {
    if(distances[distancesCounter] < 0 & distancesCounter == 2)
    {
      buffer1 <- st_buffer(inputPolygon, distances[distancesCounter])
      buffer1_ <- st_difference(inputPolygon, buffer1)
      thisRing <- st_cast(buffer1_, "POLYGON")
      #take the last column which is 'geometry'
      thisRing <- as.data.frame(thisRing[,ncol(thisRing)])
      thisRing$distance <- distances[distancesCounter]
    }
    
    else if(distances[distancesCounter] < 0 & distancesCounter > 2) 
    {
      buffer1 <- st_buffer(inputPolygon, distances[distancesCounter])
      buffer2 <- st_buffer(inputPolygon, distances[distancesCounter-1])
      thisRing <- st_difference(buffer2,buffer1)
      thisRing <- st_cast(thisRing, "POLYGON")
      thisRing <- as.data.frame(thisRing$geometry)
      thisRing$distance <- distances[distancesCounter]
    }
    
    else 
    {
      buffer1 <- st_buffer(inputPolygon, distances[distancesCounter])
      buffer1_ <- st_buffer(inputPolygon, distances[distancesCounter-1])
      thisRing <- st_difference(buffer1,buffer1_)
      thisRing <- st_cast(thisRing, "POLYGON")
      #geometry column as a data frame
      thisRing <- as.data.frame(thisRing[,ncol(thisRing)])
      thisRing$distance <- distances[distancesCounter]
    }  
    
    allRings <- rbind(allRings, thisRing)
    distancesCounter <- distancesCounter + 1
    numberOfRingsCounter <- numberOfRingsCounter + 1
  }
  allRings <- st_as_sf(allRings)
}

# Load hexadecimal color palette

palette5 <- c("#f0f9e8","#bae4bc","#7bccc4","#43a2ca","#0868ac")

# Load census API key
census_api_key("7fcf0c60997f4d8ccd298e26df0b2f35dc033150",install=TRUE, overwrite=TRUE)

#Load list of variables

acs_variable_list.2009 <- load_variables(2009, 
                                         "acs5")
acs_variable_list.2019 <- load_variables(2019, 
                                         "acs5")

#Year 2009 tracts - B15002_015 Male Bachelor's Degree; B15002_032 Female Bachelor's Degree

#need to edit state and county geoid for Boston, MA. Also need to add one more variable - we use the population variable to get the percentages

#new variables to add <- B03003_003 (HispanicPopulation) or B02001_002 (WhitePopulation) #Boston is pretty white but it would be good to see how latinos have moved around the area.
            

#Year 2009 tracts
tracts09 <-  
  get_acs(geography = "tract", variables = c("B25026_001E","B19013_001E","B25058_001E","B15002_015E","B15002_032E","B03003_003E"),
  year=2009, state=25, county=025, geometry=T) %>% 
  st_transform('ESRI:102286')    

tracts09 <- 
  tracts09 %>%
  dplyr::select( -NAME, -moe) %>%
  spread(variable, estimate) %>%
  dplyr::select(-geometry) %>%
  rename(TotalPop = B25026_001, 
         MedHHInc = B19013_001, 
         MedRent = B25058_001,
         MaleBachelors = B15002_015,
         FemaleBachelors = B15002_032,
         HispanicPop = B03003_003) 

tracts09 <- 
  tracts09 %>%
  mutate(pctHispanic = ifelse(TotalPop > 0, HispanicPop / TotalPop, 0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop), 0),
         year = "2009") %>%
  dplyr::select(-HispanicPop,-FemaleBachelors,-MaleBachelors)

#Year 2019 Tracts
tracts19 <-  
  get_acs(geography = "tract", variables = c("B25026_001E","B19013_001E","B25058_001E","B15002_015E","B15002_032E","B03003_003E"),
          year=2019, state=25, county=025, geometry=T) %>% 
  st_transform('ESRI:102286')

tracts19 <- 
  tracts19 %>%
  dplyr::select( -NAME, -moe) %>%
  spread(variable, estimate) %>%
  dplyr::select(-geometry) %>%
  rename(TotalPop = B25026_001, 
         MedHHInc = B19013_001, 
         MedRent = B25058_001,
         MaleBachelors = B15002_015,
         FemaleBachelors = B15002_032,
         HispanicPop = B03003_003)

tracts19 <- 
  tracts19 %>%
  mutate(pctHispanic = ifelse(TotalPop > 0, HispanicPop / TotalPop, 0),
               pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop), 0),
               year = "2019") %>%
  dplyr::select(-HispanicPop,-FemaleBachelors,-MaleBachelors)


#Combine 2009 and 2019 data
allTracts <- rbind(tracts2009,tracts2019)

#----TRANSIT Data: MBTA Boston-----

#Wrangling transit open data - Stations are MBTA_NODE; Routes are MBTA_ARC ---
MBTAStops <- 
    st_read("C:/Users/veron/Documents/CPLNPennDesign/590-Musa/mbta_rapid_transit/MBTA_NODE.shp") %>%
      select(STATION, LINE) %>%
  st_transform(st_crs(tracts2019))


#Visualizing this

ggplot() + 
  geom_sf(data=st_union(tracts2019)) +
  geom_sf(data=MBTAStops, 
          aes(colour = Line), 
          show.legend = "point", size= 5) +
  scale_colour_manual(values = c("orange","blue")) +
  labs(title="MBTA Stops", 
       subtitle="Boston, MA", 
       caption="Figure 1") +
  mapTheme()

# --- MBTA Stops Buffers ----

MBTABuffers <- 
  rbind(
    st_buffer(MBTAStops, 804.6) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend),
    st_union(st_buffer(MBTAStops, 804.6)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))

ggplot() +
  geom_sf(data=MBTABuffers) +
  geom_sf(data=MBTABuffers, show.legend = "point") +
  facet_wrap(~Legend) + 
  labs(caption = "Figure 2") +
  mapTheme()

# --- MBTA Multiple Buffer Rings ----
Multibuffer_union=st_union(MBTABuffers)%>%
  st_sf()

MRBuffer <-
  st_join(
    st_centroid(dplyr::select(allTracts, GEOID, year)),
    multipleRingBuffer(Multibuffer_union,10000,804.672)) %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(allTracts, GEOID, MedRent, year),
            by=c("GEOID"="GEOID", "year"="year")) %>%
  st_sf() %>%
  replace_na(list(distance = 0))%>% 
  mutate(distance = distance+804.672)

Bostonbdry <- st_union(tracts09) %>%
  st_sf()

#MultipleRingBuffer Plot
ggplot() +
  geom_sf(data=multipleRingBuffer(Multibuffer_union,10000,804.672))+
  geom_sf(data=Bostonbdry,fill = "transparent",color="black",size=0.5)+
  geom_sf(data = MBTAStops,size=0.5)+
  labs(
    title = "Half Mile Buffers",
    subtitle="Boston Boundary overlayed"
  ) +
  mapTheme()+  theme(plot.title = element_text(size=22))

#Distance to MBTAStops
ggplot(MRBuffer)+
  geom_sf(color=NA,aes(fill = q5(distance))) +
  geom_sf(data=allTracts.group,fill = "transparent",color=NA)+
  geom_sf(data = MBTAStops,size=0.5)+
  geom_sf(data = Multibuffer_union, fill = "transparent", color = "red",size=0.5)+
  scale_fill_manual(values = palette5,
                    labels = qBr(MRBuffer, "distance"),
                    name = "Distance\n(Quintile Breaks)") +
  labs(
    title = "Distance to TOD area 2009-2019",
    subtitle = "Buffer is areas within 0.5 mile from MBTA Stops"
    ) +
  mapTheme() + 
  theme(plot.title = element_text(size=20))
  
#Mean Rent as a function of distance to MBTA Stops  
  
MeanRent=MRBuffer%>%
  group_by(year,distance)%>%
  summarise(avgRent=mean(MedRent,na.rm=TRUE))

#Plot
ggplot(MeanRent, aes(y=avgRent, x=distance)) + 
  geom_line(aes(group=year, color=year), size = 1.5) + 
  geom_point(aes(color=year), size = 4,shape = 21, fill = "white") +
  scale_color_manual(values = c("#2166ac", "#ef8a62"),name="Year")+
  labs(
    title = "Rent as a function of Distance to MBTA Stops", 
    caption = "
Line plot 1

Insert description of line graph here"
    ) +
  plotTheme() + theme(plot.title = element_text(size=18),legend.position="right")

# ---- Spatial operations ----

# Three types. SelectByCentroids if the best option for this analysis

# Create an sf object with ONLY the unioned buffer
buffer <- filter(MBTABuffers, Legend=="Unioned Buffer")

# Clip 
clip <- 
  st_intersection(buffer, tracts09) %>%
  dplyr::select(TotalPop) %>%
  mutate(Selection_Type = "Clip")

# Spatial selection
selection <- 
  tracts09[buffer,] %>%
  dplyr::select(TotalPop) %>%
  mutate(Selection_Type = "Spatial Selection")

# SelectByCentroids

selectCentroids <-
  st_centroid(tracts09)[buffer,] %>%
  st_drop_geometry() %>%
  left_join(., dplyr::select(tracts09, GEOID)) %>%
  st_sf() %>%
  dplyr::select(TotalPop) %>%
  mutate(Selection_Type = "Select by Centroids")

# ---- Visualizing This ----

myData  <- rbind(selectCentroids, clip) %>%
  rbind(., selection)

ggplot(myData)+
  geom_sf(data = st_union(tracts09))+
  geom_sf(aes(fill = q5(TotalPop))) +
  scale_fill_manual(values = palette5,
                    labels = qBr(myData, "TotalPop"),
                    name = "Population\n(Quintile Breaks)") +
  labs(title = "Total Population", subtitle = "Boston; 2009") +
  facet_wrap(~Selection_Type)+
  mapTheme() + 
  theme(plot.title = element_text(size=20))

# --- Tracts grouped by Year ----
allTracts.group <- 
  rbind(
    st_centroid(allTracts)[buffer,] %>%
      st_drop_geometry() %>%
      left_join(allTracts) %>%
      st_sf() %>%
      mutate(TOD = "TOD"),
    st_centroid(allTracts)[buffer, op = st_disjoint] %>%
      st_drop_geometry() %>%
      left_join(allTracts) %>%
      st_sf() %>%
      mutate(TOD = "Non-TOD")) %>%
  mutate(MedRent.inf = ifelse(year == "2009", MedRent * 1.14, MedRent),
         MedHHInc.inf = ifelse(year == "2009", MedHHInc * 1.14, MedRent))


ggplot(allTracts.group)+
  geom_sf(data = st_union(tracts09))+
  geom_sf(aes(fill = TOD)) +
  labs(title = "Time/Space Groups") +
  facet_wrap(~year)+
  mapTheme() + 
  theme(plot.title = element_text(size=22))

# --- Four Small Multiple Visualizations ----
# MedRent 2009-2019
ggplot(allTracts.group)+
  geom_sf(data = st_union(tracts09))+
  geom_sf(aes(fill = q5(MedHHInc))) +
  geom_sf(data = buffer, fill = "transparent", color = "red")+
  scale_fill_manual(values = palette5,
                    labels = qBr(allTracts.group, "MedHHIncome"),
                    name = "Rent\n(Quintile Breaks)") +
  labs(title = "Median Rent 2009-2019", subtitle = "Real Dollars") +
  facet_wrap(~year)+
  mapTheme() + 
  theme(plot.title = element_text(size=22))

#Med HH Income 2009-2019





# --- TOD Indicator Tables ----

allTracts.Summary <- 
  st_drop_geometry(allTracts.group) %>%
  group_by(year, TOD) %>%
  summarize(Rent = mean(MedRent, na.rm = T),
            Population = mean(TotalPop, na.rm = T),
            Percent_Hispanic = mean(pctHispanic, na.rm = T),
            Percent_Bach = mean(pctBachelors, na.rm = T))

kable(allTracts.Summary) %>%
  kable_styling() %>%
  footnote(general_title = "\n",
           general = "Table 2.2")

```
```

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
