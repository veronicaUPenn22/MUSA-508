---
title: "Midterm"
author: "Me"
date: "10/8/2021"
output: 
  html_document: 
    toc: yes
    theme: united
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

# Introduction

This project aims to develop a model that can predict future home values by using geospatial machine learning processes. We basically deconstruct the different components and constituents that could describe a home and its value. As we know, usually market rate and economic valuation under capitalist systems are based on subjective factors that can be geographically identified. In a national scale, a home's location for example, might influence it's valuation over many other variables. In a more local scale, we could have both cases. First is the clustering of similar price ranges based on similarity across. Second is a differentiated price based on unique qualities of a home in contrast with its closest homes, which is often described with non-numerical factors such as aesthetic value, historical significance, style, materials, etc. 

In this model we mainly focus on the first, but we do not fully dismiss non-numerical characteristics that could help predict future home prices as well. 


# Modeling strategy and Methodology:

To develop the model we gathered all the data from Boulder Open Data, Open Street Map and the U.S. Census. We used geojson and API file formats. Secondly, we turned the homes data (provided by the instructors) into an spatial feature dataset that was then joined to the multiple external variables (parks, education, health, roads, hazards, income and age groups to name a few). Following this we did an exploratory analysis of the dataset and visualized the correlation of home prices to both internal and external variables using an ordinary least square (OLS) matrix. We used multivariate regressions to test model's fitness and which variable groups are stronger predictors than other after seeing OLS relationships. Afterwards we splitted the data into a training set (0) and a test set (1), that is then used to predict home sale prices for the Boulder County homes. This is evaluated for generalizability in the end, meaning that a second training/test model is done at the municipality scale to check if the model is a good predictor for different contexts across groups and not just our selected geography. 

# Summary of results:




## Getting Started

The libraries, directory and functions in the below code block are needed for this model:


```{r setup, include=FALSE}


knitr::opts_chunk$set(include = FALSE)
#Libraries needed for this exercise
library(tidyverse)
library(tidycensus)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) 
library(stargazer)

# Functions and data directory
root.dir = "https://raw.githubusercontent.com/veronicaUPenn22/Public-Policy-Analytics-Landing/master/DATA/"

source("https://raw.githubusercontent.com/veronicaUPenn22/Public-Policy-Analytics-Landing/master/functions.r")

# Color palette
palette5 <- c("#ffcdb2","#ffb4a2","#e5989b","#b5838d","#6d6875")

```



### Data Gathering Methods

Table of data sets

| Dataset        | Description    | Open Data URL  | File Type | Location |
| :------------- | :------------- | :------------- | :------------- | :------------- |
| Boulder County Municipalities | Boundaries polygons | https://opendata-bouldercounty.hub.arcgis.com/datasets/bouldercounty::municipalities/about | geojson | MUSA-508/Midterm |
| Boulder County Boundary | Boundary polygon | https://opendata-bouldercounty.hub.arcgis.com/datasets/county-boundary/explore?location=40.088157%2C-105.373097%2C11.58 | geojson | MUSA-508/Midterm |
| Boulder County Open Spaces | Boundaries for parks and open spaces state and municipally owned | https://opendata-bouldercounty.hub.arcgis.com/datasets/county-open-space/explore?location=40.080100%2C-105.341850%2C11.48&showTable=true | geojson | MUSA-508/Midterm |
| Student Data | Homes data for Boulder County (2019-2021) | Provided by MUSA508 instructors | geojson | MUSA-508/Midterm |
| Libraries | Points of libraries in Boulder County  | https://opendata.arcgis.com/datasets/7f4ea25ba87345e380d2e896611d2588_0.geojson | geojson | Boulder County Open Data | 
| Restaurants | 5 year ACS 2019 | osmdata package | geojson | OSM |
| Parks | Parks locations point data | osmdata package | geojson | OSM |
| Schools | Point data of elementary, middle and high schools | https://www.bouldercounty.org/government/open-data/ | geojson | MUSA-508/Midterm |
| Universities | 5 year ACS 2019 | osmdata package | geojson | OSM |
| Healthcare | Clinics and hospitals point data | osmdata package | geojson | OSM |
| Trails |-----| https://www.bouldercounty.org/government/open-data/ | geojson | MUSA-508/Midterm |
| Wildfires |-----| https://www.bouldercounty.org/government/open-data/ | geojson | MUSA-508/Midterm |
| Flood zones |-----| https://www.bouldercounty.org/government/open-data/ | geojson | MUSA-508/Midterm |
| Scenic corridors |-----| https://www.bouldercounty.org/government/open-data/ | geojson | MUSA-508/Midterm |

### Internal Characteristics: Homes and Boulder Data 

```{r Housing and Boulder shp, echo=TRUE, message=FALSE, warning=FALSE}

muni <- 
  st_read("~/CPLNPennDesign/590-Musa/Musa508-Vero/MUSA-508/Midterm/Municipalities.geojson") %>%
  st_transform('ESRI:102653')

housingData <- 
  st_read("~/CPLNPennDesign/590-Musa/Musa508-Vero/MUSA-508/Midterm/studentData.geojson", crs = 'ESRI:102254') %>%
  st_transform('ESRI:102653')

boulderCounty <-
  st_read("~/CPLNPennDesign/590-Musa/Musa508-Vero/MUSA-508/Midterm/County_Boundary.geojson")%>%
  st_transform('ESRI:102653')

boulder.sf <- housingData %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102653') %>%
  mutate(pricesqft = ifelse(TotalFinishedSF > 0, (price/TotalFinishedSF), 0),
    TotalBathrooms = nbrThreeQtrBaths + nbrFullBaths + nbrHalfBaths) %>%
  rename(Size = TotalFinishedSF, 
         TotalBedrooms = nbrBedRoom, 
         GarageSize = carStorageSF,
         BuildingType = designCodeDscr,
         Quality = qualityCodeDscr,
         YearBuilt = EffectiveYear,
         Construction = ConstCodeDscr,
         Internal = IntWallDscr)

#State Plane Colorado - ESRI:102653
#Colorado North - ESRI:102253
#Colorado Central - ESRI:102254
#Boulder - SR-ORG:7992  

```

Visualizing home prices spatially distributed across Boulder County.

```{r Price Map, echo=FALSE, message=FALSE, warning=FALSE}

ggplot() +
  geom_sf(data = boulderCounty, fill = "grey90") +
  geom_sf(data = muni, fill = NA) +
  geom_sf(data = boulder.sf, aes(colour = q5(price)), 
          show.legend = "point", size = .5) +
  scale_color_manual(values = palette5,
                   labels = qBr(boulder.sf, "price"),
                   name = "Quintile\nBreaks") +
  geom_sf_label(data = muni, aes(label = ZONEDESC), size = 2) +
  labs(title="Gross Home Prices in Boulder County") +
  mapTheme()
```

## What internal and external factors influence home value?

We selected a few variables that we believe would be good price predictors for home prices in Boulder County. 

Context for external: 
Based on the demographics, it is a relatively white county, with over 85% of the population being white. median income rates are also high in about 80k for median income, doubling the national average. This should explain why ownership is higher than rented homes for example. Most people seem to drive to work, and the average commute in the county is 23 minutes. 
Parks and open spaces are an important highlight of Boulder County as well. These amenities are an attraction to both locals and tourists, probably becoming a strong factor influencing home values relative to their proximity. Physical activity and access to green trails seems important for households in Boulder County. A survey by the Centers for Disease Control found that Colorado had fewer overweight people per capita and more people who exercise than any other state. While most people commute by car to jobs and amenities, it seems that physical activity is described through these natural assets. In a post COVID/work from home scenario, access to these sites might be a strong variable for home price. 
Based on census and fast facts, education, health and leisure seem a priority for Boulder County citizens. Distance to amenities such as schools, colleges, universities, and restaurants are also considered in this project. 

Homes' internal characteristics:
Physical characteristics of the homes are important factors for predicting home values. As in appraisals, the quality, age, size, number of bedrooms and bathrooms all influence it valuation. Functioning characteristics such as AC/Heating and plumbing systems also influence price.


## Gathering and Wrangling External Characteristics

### OSM Data for Boulder County

Open Street Map

```{r OSM, echo=FALSE}
install.packages("osmdata")
library(osmdata)
library(tigris)

q0 <- opq(bbox = c("Boulder County")) #bounding box for boulder

#---- Libraries -----

libraries <-
   st_read("https://opendata.arcgis.com/datasets/7f4ea25ba87345e380d2e896611d2588_0.geojson") %>%
  st_transform(st_crs('ESRI:102653'))

#---- Trails -----

trails <- 
   st_read("https://opendata.arcgis.com/datasets/3a950053bbef46c6a3c2abe3aceee3de_0.geojson") %>%
  st_transform(st_crs('ESRI:102653')) 

#---- Marihuana Establishments -----

marijuanaestablishments <- 
   st_read("https://opendata.arcgis.com/datasets/425a0adb547a4faba4b741a4fe4373b1_0.geojson") %>%
  st_transform(st_crs('ESRI:102653'))

#---- Parks ----

parks <- add_osm_feature(opq = q0, key = 'leisure', value = "park") %>%
  osmdata_sf(.)

parks.sf <- st_geometry(parks$osm_polygons) %>%
  st_as_sf(crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102286') %>%
  cbind(., parks$osm_polygons$name) %>%
  rename(NAME = parks.osm_polygons.name, geometry = "x") %>%
  st_centroid()


# ----- Schools + Universities----

schools <- 
  st_read("~/CPLNPennDesign/590-Musa/Musa508-Vero/MUSA-508/Midterm/Schools_Boulder.shp") %>%
  st_transform('ESRI:102653')

university <- add_osm_feature(opq = q0, key = 'amenity', value = "university") %>%
  osmdata_sf(.)
university.sf <- st_geometry(uni$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., uni$osm_points$osm_id) %>% 
  rename(NAME = uni.osm_points.osm_id)


# ----- Hospitals + Clinics ----
hospitals <- add_osm_feature(opq = q0, key = 'amenity', value = "hospital") %>%
  osmdata_sf(.)
hospitals.sf <- st_geometry(hospitals$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., hospitals$osm_points$amenity) %>%
  rename(NAME = hospitals.osm_points.amenity)

clinics <- add_osm_feature(opq = q0, key = 'amenity', value = "clinic") %>%
  osmdata_sf(.)
clinics.sf <- st_geometry(clinics$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., clinics$osm_points$amenity) %>%
  rename(NAME = clinics.osm_points.amenity)

healthcare <- rbind(hospitals.sf,clinics.sf)


#---- Restaurants -----
restaurant <- add_osm_feature(opq = q0, key = 'amenity', value = "restaurant") %>%
  osmdata_sf(.)
restaurant.sf <- st_geometry(restaurant$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., restaurant$osm_points$amenity) %>%
  rename(NAME = restaurant.osm_points.amenity)


#---- Disaster Risks -----
sceniccorridor <- 
   st_read("https://opendata.arcgis.com/datasets/749ed0a11e454f64a0e5f7c51a786129_0.geojson") %>%
   st_transform(st_crs('ESRI:102653'))

geohazards <- 
   st_read("https://opendata.arcgis.com/datasets/ccb02305e30346a4848c99ff94a0e928_0.geojson") %>%
   st_transform(st_crs('ESRI:102653'))

floodzones <-
   st_read("https://opendata.arcgis.com/datasets/a9624bd25d854ef7ab0d543e9490ce48_0.geojson") %>%
   st_transform(st_crs('ESRI:102653'))

wildfires <-
   st_read("https://opendata.arcgis.com/datasets/61f20f4a64274969a9e740eda5c62de7_0.geojson") %>%
   st_transform(st_crs('ESRI:102653'))



#---- Adding features to the home data ----

st_c <- st_coordinates

#libraries
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      libraries_nn1 = nn_function(st_c(boulder.sf), st_c(libraries), 1),
      libraries_nn2 = nn_function(st_c(boulder.sf), st_c(libraries), 2), 
      libraries_nn3 = nn_function(st_c(boulder.sf), st_c(libraries), 3), 
      libraries_nn4 = nn_function(st_c(boulder.sf), st_c(libraries), 4), 
      libraries_nn5 = nn_function(st_c(boulder.sf), st_c(libraries), 5)) 

#trails
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      trails_nn1 = nn_function(st_c(boulder.sf), st_c(trails), 1),
      trails_nn2 = nn_function(st_c(boulder.sf), st_c(trails), 2), 
      trails_nn3 = nn_function(st_c(boulder.sf), st_c(trails), 3), 
      trails_nn4 = nn_function(st_c(boulder.sf), st_c(trails), 4), 
      trails_nn5 = nn_function(st_c(boulder.sf), st_c(trails), 5)) 

#marijuana establishments
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      marijuanaestablishments_nn1 = nn_function(st_c(boulder.sf), st_c(marijuanaestablishments), 1),
      marijuanaestablishments_nn2 = nn_function(st_c(boulder.sf), st_c(marijuanaestablishments), 2), 
      marijuanaestablishments_nn3 = nn_function(st_c(boulder.sf), st_c(marijuanaestablishments), 3), 
      marijuanaestablishments_nn4 = nn_function(st_c(boulder.sf), st_c(marijuanaestablishments), 4), 
      marijuanaestablishments_nn5 = nn_function(st_c(boulder.sf), st_c(marijuanaestablishments), 5))

#schools (elementary school, middle school, high school)
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      schools_nn1 = nn_function(st_c(boulder.sf), st_c(schools), 1),
      schools_nn2 = nn_function(st_c(boulder.sf), st_c(schools), 2), 
      schools_nn3 = nn_function(st_c(boulder.sf), st_c(schools), 3), 
      schools_nn4 = nn_function(st_c(boulder.sf), st_c(schools), 4), 
      schools_nn5 = nn_function(st_c(boulder.sf), st_c(schools), 5)) 

#university
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      university_nn1 = nn_function(st_c(boulder.sf), st_c(university.sf), 1),
      university_nn2 = nn_function(st_c(boulder.sf), st_c(university.sf), 2), 
      university_nn3 = nn_function(st_c(boulder.sf), st_c(university.sf), 3), 
      university_nn4 = nn_function(st_c(boulder.sf), st_c(university.sf), 4), 
      university_nn5 = nn_function(st_c(boulder.sf), st_c(university.sf), 5)) 

# Parks
# I moved the centroids function to the upper section
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      parks_nn1 = nn_function(st_c(boulder.sf), st_c(parks.sf),1),
      parks_nn2 = nn_function(st_c(boulder.sf), st_c(parks.sf), 2), 
      parks_nn3 = nn_function(st_c(boulder.sf), st_c(parks.sf), 3), 
      parks_nn4 = nn_function(st_c(boulder.sf), st_c(parks.sf), 4), 
      parks_nn5 = nn_function(st_c(boulder.sf), st_c(parks.sf), 5)) 

#healthcare facilities
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      healthcare_nn1 = nn_function(st_c(boulder.sf), st_c(healthcare), 1),
      healthcare_nn2 = nn_function(st_c(boulder.sf), st_c(healthcare), 2), 
      healthcare_nn3 = nn_function(st_c(boulder.sf), st_c(healthcare), 3), 
      healthcare_nn4 = nn_function(st_c(boulder.sf), st_c(healthcare), 4), 
      healthcare_nn5 = nn_function(st_c(boulder.sf), st_c(healthcare), 5)) 

#restaurants
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      restaurant_nn1 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 1),
      restaurant_nn2 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 2), 
      restaurant_nn3 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 3), 
      restaurant_nn4 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 4), 
      restaurant_nn5 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 5)) 

#Disaster risks

#floodzones
floodzones <-
  floodzones %>%
  mutate(floodzone = 1) 

boulder.sf <-
  st_join(boulder.sf, floodzones)

boulder.sf$floodzones =
  ifelse(is.na(boulder.sf$floodzone),0, 1)

#scenic corridor
sceniccorridor <-
 sceniccorridor %>%
 mutate(sceniccorridor = 1)
boulder.sf <-
  st_join(boulder.sf, sceniccorridor) 
boulder.sf$sceniccorridor =
  ifelse(is.na(boulder.sf$sceniccorridor),0, 1)

#wildfire
#boulder.sf <- boulder.sf[-c(84:124)]

wildfires <-
 wildfires %>%
 mutate(wildfire = 1)
boulder.sf <-
  st_join(boulder.sf, wildfires)
boulder.sf$wildfires =
  ifelse(is.na(boulder.sf$wildfires),0, 1)

#Geohazards
boulder.sf <-
  st_join(boulder.sf, geohazards)

```
```{r}

#Map of external characteristics // or summary table, however works best
## Home Buffer

#A 5 mile buffer is created from Boulder homes. Graphical purposes only
BoHomeBuffers <- 
  rbind(
    st_buffer(boulder.sf, 2640) %>%
      mutate(Legend = "5mi Buffer") %>%
      dplyr::select(Legend),
  st_union(st_buffer(boulder.sf, 2640)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))

Unioned_buffer <- filter(BoHomeBuffers, Legend=="Unioned Buffer")

ggplot()+
  geom_sf(data = boulder, color = "black")+
  scale_color_manual(values = c("orange", "blue"))+
  geom_sf(data = park.sf, fill = "light green", color = "transparent")+
  geom_sf(data = restaurant.sf, color = "red", size = 0.2, alpha = 0.2)

```

## Using Demographic Data as descriptor

Retrieved from US Census Bureau. ACS 2019 5 year

```{r message=FALSE, warning=FALSE}
# Load census API key
census_api_key("7fcf0c60997f4d8ccd298e26df0b2f35dc033150",install=TRUE, overwrite=TRUE)

#Load list of variables
acs_variable_list.2019 <- load_variables(2019,"acs5")


#Year 2019 tracts
tracts19 <-  
  get_acs(geography = "tract", variables = c("B25026_001E","B19013_001E","B01002_001E","B02001_002"),
          year=2019, state=08, county=013, geometry=T) %>% 
  st_transform('ESRI:102653')

tracts19 <- 
  tracts19 %>%
  select( -NAME, -moe) %>%
  spread(variable, estimate) %>%
  select(-geometry) %>%
  rename(TotalPop = B25026_001, 
         MedHHInc = B19013_001, 
         medianage = B01002_001,
         WhitePop = B02001_002) 

#point to polygon spatial join
boulder.sf <-
  boulder.sf  %>% 
    mutate(
      st_join(boulder.sf, tracts19, join = st_within))

```

## Exploratory Analysis: Correlation Plots

The Exploratory Analysis here helped us understand which variables (internal and external; numeric or categorical) are positively correlated to price change. 

```{r message=FALSE, warning=FALSE}

#Internal Characteristics Correlation Plots
st_drop_geometry(boulder.sf) %>% 
  mutate(Age = 2015 - builtYear) %>%
  dplyr::select(price, Size, Age, TotalBedrooms, TotalBathrooms, GarageSize) %>%
  filter(price <= 1000000, Age < 500) %>%
  gather(Variable, Value, -price) %>% 
  ggplot(aes(Value, price)) +
     geom_point(size = .5) + geom_smooth(method = "lm", se=F, colour = "#FA7800") +
     facet_wrap(~Variable, ncol = 4, scales = "free") +
     labs(title = "Price as a function of continuous variables") +
     plotTheme()

```

Numerical features describing pertaining to house size are positively correlated to price. Age is negatively correlated to price. 

### Correlation to Categorical Variables 

Price as a function of non numeric variables. In the plots above, we see how price increases as age decreases, and how numeric variables are positively correlated to price increase. Looking at non numeric attributes of the home might shed interesting insight for understanding why age is negatively correlated to price. A general assumption here could be that architectural styles in this County are not historically valuable to appraisers. Meaning that age may not add appraising value to a property here in contrast to cities like Washington DC or Philadelphia, for example, which have greater historical valuation. 

```{r Non numeric}

st_drop_geometry(boulder.sf) %>% 
  dplyr::select(price, BuildingType, Quality, Construction, Internal) %>%
  filter(price <= 1000000) %>%
  gather(Variable, Value, -price) %>% 
   ggplot(aes(Value, price)) +
     geom_bar(position = "dodge", stat = "summary", fun.y = "mean", scientific = FALSE) +
     facet_wrap(~Variable, ncol = 2, scales = "free") +
     labs(title = "Price as a function of categorical variables", y = "Mean_Price") +
     plotTheme() + theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

As you can see on the bar plots, categorical variables influence price increase significantly. Building typology, material, interiority, and the quality rate from appraisals determine price strongly. While building type and material might be good features to use in a prediction model, quality should be used cautiously, as there is a level of bias in appraisals that the data may not reflect.

### Correlation to external features


```{r}

#Price as function of distance to parks
boulder.sf %>%
  st_drop_geometry() %>%
  mutate(Age = 2015 - builtYear) %>%
  dplyr::select(price, starts_with("parks_")) %>%
  filter(price <= 1000000) %>%
  gather(Variable, Value, -price) %>% 
   ggplot(aes(Value, price)) +
     geom_point(size = .5) + geom_smooth(method = "lm", se=F, colour = "#FA7800") +
     facet_wrap(~Variable, nrow = 1, scales = "free") +
     labs(title = "Price as a function of Nearest Parks") +
     plotTheme()

```

```{r}

#Correlation to other external characteristics
st_drop_geometry(boulder.sf) %>% 
  mutate(Age = 2015 - builtYear) %>%
  dplyr::select(price, Age, TotalPop, WhitePop, MedHHInc, medianage, trails_nn1, schools_nn1, restaurant_nn1, university_nn5, healthcare_nn1) %>%
  filter(price <= 1000000, Age < 500) %>%
  gather(Variable, Value, -price) %>% 
  ggplot(aes(Value, price)) +
     geom_point(size = .5) + geom_smooth(method = "lm", se=F, colour = "#FA7800") +
     facet_wrap(~Variable, ncol = 2, scales = "free") +
     labs(title = "Price as a function of continuous variables") +
     plotTheme()

```
Additional variables that we looked at are 


### Regressions for determining correlation strength 

Statistical significance of size
```{r}
reg1 <- lm(price ~ Size, data = boulder.sf)

#Table 1 Kable-Tidy
reg1 %>%
  tidy() %>%
  mutate(p.value = scales::pvalue(p.value))%>%
  kable(
    caption = "Coefficient-Level Estimates for a Model Fitted to Predict Home Prices in 
    Boulder County", 
    col.names = c("Predictor", "Estimate", "Std.Err", "t-stat", "p-value"), 
    digits = c(0, 2, 3, 2, 3),
    align = c("l", "r", "r", "r", "r")
  ) %>%
  kable_styling()
    
summary(reg1)

#Table 1 (Stargazer)
stargazer(reg1, type = "html", 
          dep.var.labels=c("Price total"),
          covariate.labels=c("Size in sqm"))

```
The following two regressions test significance of multiple internal features and then several external features we engineered in the previous part of this exercise.

```{r Internal Features Regression}
head(boulder.sf)

reg2 <- lm(price ~ ., data = st_drop_geometry(boulder.sf) %>% 
                                 dplyr::select(price, Size, builtYear, 
                                               Construction, BuildingType, Internal, Quality,
                                               TotalBedrooms, TotalBathrooms
                                               ))
summary(reg2)

reg2 %>%
  tidy() %>%
  kable(
    caption = "Coefficient-Level Estimates for a Model Fitted to Predict Home Prices in 
    Boulder County", 
    col.names = c("Predictor", "Estimate", "Std.Err", "t-stat", "p-value"), 
    digits = c(0, 2, 3, 2, 3),
    align = c("l", "r", "r", "r", "r")
  ) %>%
  kable_styling() %>%
  footnote(general = "Adjusted R-squared:  0.4114")

```


```{r External Features Regression}

reg3 <- lm(price ~ ., data = st_drop_geometry(boulder.sf) %>% 
                                 dplyr::select(price, Size, builtYear, 
                                               Construction, BuildingType, Quality,
                                               TotalBedrooms, TotalBathrooms, MedHHInc, TotalPop,
                                               WhitePop, medianage))
summary(reg3)


reg3 %>%
  tidy() %>%
  kable(
    caption = "Coefficient-Level Estimates for a Model Fitted to Predict Home Prices in 
    Boulder County", 
    col.names = c("Predictor", "Estimate", "Std.Err", "t-stat", "p-value"), 
    digits = c(0, 2, 3, 2, 8),
    align = c("l", "r", "r", "r", "r")
  ) %>%
  kable_styling() %>%
  footnote(general = "Adjusted R-squared:  0.422")


#Coefficients of all models
plot_summs(reg1, reg3, reg2)
```

The above model shows how including demographic features such as HH Income, Population, Age and Race add greater significance to the overall regression.

```{r}

reg4 <- lm(price ~ ., data = st_drop_geometry(boulder.sf) %>% 
                                 dplyr::select(price, Size, builtYear, 
                                               Construction, BuildingType, Quality,
                                               TotalBedrooms, TotalBathrooms, MedHHInc, TotalPop,
                                               WhitePop, medianage, parks_nn1, parks_nn3,
                                               schools_nn1, schools_nn3, schools_nn5, 
                                               university_nn1, libraries_nn1,
                                               healthcare_nn3, trails_nn3,
                                               restaurant_nn1,
                                               marijuanaestablishments_nn1, 
                                               marijuanaestablishments_nn2,
                                               marijuanaestablishments_nn5, sceniccorridor))

summary(reg4)

reg4 %>%
  tidy() %>%
  kable(
    caption = "Coefficient-Level Estimates for a Model Fitted to Predict Home Prices in 
    Boulder County", 
    col.names = c("Predictor", "Estimate", "Std.Err", "t-stat", "p-value"), 
    digits = c(0, 2, 3, 2, 8),
    align = c("l", "r", "r", "r", "r")
  ) %>%
  kable_styling() %>%
  footnote(general = "Adjusted R-squared:  0.4955")

```
When adding many external features and amenities (ie, parks, schools, university and trails, etc), the adjusted r-squared value is telling us that 50% of the variables in this list could be statistically significant to price. 

### Correlation Matrix

```{r message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

corrplot <- st_drop_geometry(boulder.sf) %>% 
  select(price, Size, TotalBathrooms, TotalBedrooms, GarageSize, MedHHInc, TotalPop, medianage, WhitePop, parks_nn1, trails_nn1, schools_nn1, libraries_nn1, university_nn1, healthcare_nn1, restaurant_nn1, marijuanaestablishments_nn1, sceniccorridor) %>% na.omit(na.action = "omit")

ggcorrplot(
  round(cor(corrplot), 1), 
  p.mat = cor_pmat(corrplot),
  show.diag = TRUE,
  colors = c("#8d2323", "white", "#ddaa88"),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation across numeric variables")

```

## Training the Model for homeprice predictions

In this section and forward in the document, we use the featured engineered data set for the housing data and split it into two groups: a training set and a test set. 

```{r}

#----Training vs test set----

bouldert.sf <- filter(boulder.sf, toPredict==0)

inTrain <- createDataPartition(
              y = paste(bouldert.sf$Size, bouldert.sf$builtYear, bouldert.sf$TotalBedrooms), 
              p = .75, list = FALSE)

boulder.training <- bouldert.sf[inTrain,] 
boulder.test <- bouldert.sf[-inTrain,]  

reg.training <- lm(price ~ ., data = st_drop_geometry(boulder.training) %>% 
                                    dplyr::select(price, Size, builtYear, TotalBedrooms,                                                   TotalBathrooms, university_nn1, parks_nn1,parks_nn2))

boulder.test <-
  boulder.test %>%
  mutate(price.Predict = predict(reg.training, boulder.test),
         price.Error = price.Predict - price,
         price.AbsError = abs(price.Predict - price),
         price.APE = (abs(price.Predict - price)) / price.Predict)%>%
  filter(price < 5000000)


#----MAE----
mean(boulder.test$price, na.rm = T)
mean(boulder.test$price.AbsError, na.rm = T)
  #

#----MAPE----
mean(boulder.test$price.APE, na.rm = T)
  #model errors by 36%

#----Generalizability----
fitControl <- trainControl(method = "cv", number = 100)
set.seed(825)

reg.cv <- 
  train(price ~ ., data = st_drop_geometry(bouldert.sf) %>% 
                                dplyr::select(price, Size, builtYear, TotalBedrooms,                                                  TotalBathrooms, university_nn1, parks_nn1,                                                      parks_nn2), 
     method = "lm", trControl = fitControl, na.action = na.pass)

reg.cv
reg.cv$resample[1:5,]

#Histogram of MAE and MAPE

ggplot(boulder.test, aes(x = price.AbsError)) + 
  geom_histogram(fill="#b5838d", color= "grey") +
  #scale_x_continuous(breaks = round(c(price.AbsError))) +
  geom_vline(aes(xintercept=mean(price.AbsError)), color="black",
             linetype="dashed")
  theme()
  
#Predicted prices as a function of observed prices
boulder.test %>%
  st_drop_geometry() %>%
  dplyr::select(price, price.Predict) %>%
  filter(price <= 1000000) %>%
  gather(Variable, Value, -price) %>% 
   ggplot(aes(Value, price)) +
     geom_point(size = .5) + geom_smooth(method = "lm", se=F, colour = "#FA7800") +
     facet_wrap(~Variable, nrow = 1, scales = "free") +
     labs(title = "Predicted Price as a function of Observed Prices") +
     plotTheme()


```
## Map of Predicted Prices: Entire Dataset

```{r}

boulder.test$price.Predict<- predict(boulder.training, newdata = boulder.test)

feature <- c("toPredict = 0", "toPredict = 1")
names(feature) <- c(0,1)

price.Predict <- ggplot() + 
  geom_sf(data = boulder,fill = "grey90") +
  geom_sf(data = boulder.s,aes(color = q5(Predicted.Price)),size = .5) +
  scale_color_manual(values = palette5,
                     labels = qBr(boulder.s,'Predicted.Price'),
                     name = "Price, $") +
  facet_wrap(~as.factor(toPredict),
             labeller = labeller(toPredict = feature)) +
  labs(title = 'Map of Predicted Sale Price\n',
       subtitle = '',
       caption = 'Figure RESULT 7') +
  mapTheme() + 
  plotTheme()

predicted.price

```



## Testing model accuracy: Price predictions by Census Tracts

The tracts effects accounts for the mean of prices if the values from price to prediction are equal, meaning that other categorical features might be good for price prediction. 

Summary of reg.tracts will indicate if census tracts is highly significant here. 

```{r}

#Grouping prediction data by muni
left_join(
  st_drop_geometry(boston.test) %>%
    group_by(Name) %>%
    summarize(meanPrice = mean(SalePrice, na.rm = T)),
  mutate(boston.test, predict.fe = 
                        predict(lm(SalePrice ~ Name, data = boston.test), 
                        boston.test)) %>%
    st_drop_geometry %>%
    group_by(Name) %>%
      summarize(meanPrediction = mean(predict.fe))) %>%
      kable() %>% kable_styling()


#Prediction Data by Municipality
reg.nhood <- lm(SalePrice ~ ., data = as.data.frame(boston.training) %>% 
                                 dplyr::select(Name, SalePrice, LivingArea, 
                                               Style, GROSS_AREA, NUM_FLOORS.cat,
                                               R_BDRMS, R_FULL_BTH, R_HALF_BTH, 
                                               R_KITCH, R_AC, R_FPLACE,crimes.Buffer))

boston.test.nhood <-
  boston.test %>%
  mutate(Regression = "Neighborhood Effects",
         SalePrice.Predict = predict(reg.nhood, boston.test),
         SalePrice.Error = SalePrice.Predict- SalePrice,
         SalePrice.AbsError = abs(SalePrice.Predict- SalePrice),
         SalePrice.APE = (abs(SalePrice.Predict- SalePrice)) / SalePrice)%>%
  filter(SalePrice < 5000000)


#binds error metrics
bothRegressions <- 
  rbind(
    dplyr::select(boston.test, starts_with("SalePrice"), Regression, Name) %>%
      mutate(lagPriceError = lag.listw(spatialWeights.test, SalePrice.Error)),
    dplyr::select(boston.test.nhood, starts_with("SalePrice"), Regression, Name) %>%
      mutate(lagPriceError = lag.listw(spatialWeights.test, SalePrice.Error))) 

```

## Scatterplot plot of MAPE by neighborhood as a function of mean price

```{r}

st_drop_geometry(bothRegressions) %>%
  group_by(Regression, Name) %>%
  summarize(mean.MAPE = mean(SalePrice.APE, na.rm = T)) %>%
  ungroup() %>% 
  left_join(nhoods) %>%
    st_sf() %>%
    ggplot() + 
      geom_sf(aes(fill = mean.MAPE)) +
      geom_sf(data = bothRegressions, colour = "black", size = .5) +
      facet_wrap(~Regression) +
      scale_fill_gradient(low = palette5[1], high = palette5[5],
                          name = "MAPE") +
      labs(title = "Mean test set MAPE by neighborhood") +
      mapTheme()

#Table differentiating MAPE from MAE
st_drop_geometry(bothRegressions) %>%
  gather(Variable, Value, -Regression, -Name) %>%
  filter(Variable == "SalePrice.AbsError" | Variable == "SalePrice.APE") %>%
  group_by(Regression, Variable) %>%
    summarize(meanValue = mean(Value, na.rm = T)) %>%
    spread(Variable, meanValue) %>%
    kable()


```

## Generalizability of the models in this project

In class, we discussed the concept of generalizability





### Misc

```{r}
# Add the features for Boulder County
# You can use this to clip things if it's necessary
coCounties <- counties(state = 'CO', cb = FALSE)

boulder <- coCounties %>%
  filter(NAME == "Boulder") %>%
  st_as_sf() %>%
  st_transform(4326)


schools <- add_osm_feature(opq = q0, key = 'amenity', value = "school") %>%
  osmdata_sf(.)
schools.sf <- st_geometry(schools$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., schools$osm_points$amenity) %>%
  rename(NAME = "School")
```

